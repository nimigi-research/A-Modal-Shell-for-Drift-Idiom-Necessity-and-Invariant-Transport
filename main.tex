% =====================================================================
% A Modal Shell for Drift, Idiom Necessity, and Invariant Transport
% Monolithic main.tex (drop-in replacement)
% =====================================================================
\documentclass[11pt]{article}

% -------------------- Encoding & Geometry --------------------
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage[margin=1in]{geometry}

% -------------------- Math & Theorems --------------------
\usepackage{amsmath,amssymb,amsthm,mathtools}
\usepackage{bm,bbm}
\usepackage{booktabs}

% -------------------- Hyperrefs & Cleveref --------------------
\usepackage{hyperref}
\usepackage[nameinlink,noabbrev]{cleveref}

% -------------------- Bibliography (biblatex/biber) --------------------
\usepackage[backend=biber,style=authoryear,maxcitenames=2,maxbibnames=9,doi=false,isbn=false,url=false]{biblatex}
\addbibresource{refs.bib} % your global bibliography
\addbibresource{refs_modal_shell.bib} % companion file provided with this paper

% -------------------- Environments & Macros --------------------
\theoremstyle{plain}
\newtheorem{theorem}{Theorem}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}

\newcommand{\E}{\mathbb{E}}
\newcommand{\Prob}{\mathbb{P}}
\newcommand{\1}{\mathbbm{1}}
\newcommand{\KL}{\mathrm{KL}}
\newcommand{\Wone}{W_1}

\title{A Modal Shell for Drift, Idiom Necessity, and Invariant Transport\\
\large μ-Calculus Semantics, p-Morphism Preservation, and QFI-Compatible Scheduling}
\author{}
\date{August 16, 2025}

% =====================================================================
\begin{document}
\maketitle

\begin{abstract}
We present a \emph{modal shell}---a typed modal logic with probabilistic modalities and fixpoints---that specifies, preserves, and schedules epistemic properties of systems compiled across idioms (set-theoretic kernels, categorical probability, and quotient flows). Semantically, the shell is given by Kripke structures enriched with stochastic drift and guarded by compile-time contracts; syntactically, it extends the modal $\mu$-calculus with idiom-indexed boxes $\Box_{\mathsf{I}}$ and probabilistic thresholds $\Box^{\geq q}$, enabling safety/liveness specifications and canonicals used by QFI instrumentation. We prove p-morphism preservation, idiom-indexed necessity, and soundness of drift-time operators, with standard fixpoint semantics à la Kozen for the $\mu$/$\nu$ binders \parencite{Kozen1983,BlackburnRijkeVenema2001,Stirling2001}. The shell interoperates with \emph{Idiom Projections} (FI transport and CRLB monotonicity), the \emph{Quotient Flow Invariant} (spectral--LDP diagnostics and Murphy horizons), \emph{Flow Centrality} (graph geometry of inference), and \emph{Ergodic Metric Drift} (coverage guarantees under weak dependence/regeneration) \parencite{elliott2025idiom,elliott2025qfi,elliott2025flow,elliott2025drift,DemboZeitouni1998,MeynTweedie2009}. The result is a time-aware, idiom-safe, invariant-carrying logic for specifying what must hold, when, and with what budget---the instrumentation layer used in KI-\(\Delta\)2 \parencite{elliott2025ki}.
\end{abstract}

\section{Introduction}
The modal shell is a \emph{specification layer} for Gwanglin’s idiom-correspondence program: statements written in the shell must be preserved as we compile models between idioms and coarse-grain them to quotient flows where QFI/Flow machinery runs. Three design criteria guide the construction:
\begin{enumerate}
  \item \textbf{Idiomatic necessity.} Modalities carry an idiom index $\Box_{\mathsf{I}}$ (e.g.\ set, categorical, quotient) with p-morphism preservation so truths in one idiom lift/push forward correctly \parencite[Ch.\ 2--3]{BlackburnRijkeVenema2001}.
  \item \textbf{Drift and time.} A probabilistic next operator $\bigcirc_{p}$ and cumulative operators quantify over stochastic drift; $\mu$/$\nu$ binders capture liveness/safety in the standard modal $\mu$-calculus sense \parencite{Kozen1983,Stirling2001}.
  \item \textbf{Invariant transport.} Formulas must be compatible with QFI invariants and with FI/CRLB transport under idiom projections \parencite{elliott2025qfi,elliott2025idiom}.
\end{enumerate}
Beyond expressivity, the shell serves scheduling: formulas condition Murphy horizons and focus probes along Flow-Central bottlenecks, while drift-validity guarantees make $\mu$-formulas discoverable within finite budgets \parencite{elliott2025flow,elliott2025drift,elliott2025pmb}.

\section{Syntax}\label{sec:syntax}
Let $\mathsf{AP}$ be atomic predicates over system states (typed by compile-time contracts). Formulas $\varphi$ are generated by:
\[
\varphi \;::=\; \top \mid a \mid \neg \varphi \mid \varphi \land \psi \mid \Box_{\mathsf{I}} \varphi \mid \Box^{\ge q} \varphi \mid \bigcirc_{p}\varphi \mid \mu X.\,\varphi(X) \mid \nu X.\,\varphi(X),
\]
where $a\in\mathsf{AP}$, $\mathsf{I}\in\{\mathsf{Set},\mathsf{Cat},\mathsf{QF}\}$, $q\in[0,1]$, $p\in[0,1]$, and $X$ is a formula variable occurring positively. $\Box_{\mathsf{I}}$ reads ``necessary in idiom $\mathsf{I}$''; $\Box^{\ge q}$ is a probabilistic necessity \parencite[Ch.\ 8]{BlackburnRijkeVenema2001}; $\bigcirc_{p}$ is a single-step chance-guarded next; $\mu$/$\nu$ are least/greatest fixpoints \parencite{Kozen1983}.

\section{Semantics}\label{sec:semantics}
\paragraph{Frames.} A \emph{drifted idiom frame} is
\[
\mathcal{F} \;=\; \big( W,\; \{R_{\mathsf{I}}\}_{\mathsf{I}},\; \mathsf{Drift},\; \mathcal{V}\big),
\]
with states $W$, accessibility relations $R_{\mathsf{I}}\subseteq W\times W$ (idiom-indexed), a Markov kernel $\mathsf{Drift}:W\rightsquigarrow W$ (stochastic drift), and valuation $\mathcal{V}:\mathsf{AP}\to 2^W$. In quotient idiom $\mathsf{QF}$, $R_{\mathsf{QF}}$ is induced by the row-stochastic matrix $P$ obtained via aggregation \parencite{elliott2025qfi}.

\paragraph{Interpretation.} Given a state $w$,
\begin{align*}
w \Vdash \Box_{\mathsf{I}}\varphi &\iff \forall v\,(w R_{\mathsf{I}} v \Rightarrow v\Vdash\varphi),\\
w \Vdash \Box^{\ge q}\varphi &\iff \mathsf{Drift}(w,\{v:v\Vdash\varphi\}) \ge q,\\
w \Vdash \bigcirc_{p}\varphi &\iff \mathsf{Drift}(w,\{v:v\Vdash\varphi\}) \ge p,\\
w \Vdash \mu X.\,\varphi(X) &\iff w\in \bigcap\{S\subseteq W:\; \varphi(S)\subseteq S\},\\
w \Vdash \nu X.\,\varphi(X) &\iff w\in \bigcup\{S\subseteq W:\; S\subseteq \varphi(S)\}.
\end{align*}
These are standard for probabilistic/modal $\mu$-calculus models \parencite{Kozen1983,Stirling2001}, extended here with idiom-indexed relations and a contract-typed valuation (Section~\ref{sec:types}).

\section{p-Morphisms and idiom-indexed preservation}\label{sec:pmor}
A \emph{p-morphism} between frames $\pi:\mathcal{F}\to\mathcal{F}'$ preserves truth of $\Box$-formulas and $\mu$-formulas under back-and-forth conditions \parencite[Ch.\ 2]{BlackburnRijkeVenema2001}. In our idiom setting:

\begin{definition}[Idiom p-morphism]
A map $\pi:W\to W'$ is an \emph{idiom p-morphism} if for each $\mathsf{I}$:
\begin{itemize}
\item (Forth) $w R_{\mathsf{I}} v \Rightarrow \pi(w) R'_{\mathsf{I}} \pi(v)$,
\item (Back) $\pi(w) R'_{\mathsf{I}} u' \Rightarrow \exists v\,(w R_{\mathsf{I}} v\ \&\ \pi(v)=u')$,
\end{itemize}
and $\mathsf{Drift}$ is respected: $\mathsf{Drift}(w,\cdot)$ pushed forward by $\pi$ equals $\mathsf{Drift}'(\pi(w),\cdot)$ on $\pi$-measurable sets.
\end{definition}

\begin{theorem}[Preservation]\label{thm:preservation}
If $\pi$ is an idiom p-morphism, then for all $\varphi$ in the modal $\mu$-fragment,
\[
w \Vdash \varphi \quad\Longrightarrow\quad \pi(w) \Vdash' \varphi.
\]
\end{theorem}

\noindent\emph{Proof sketch.} Standard induction on structure and approximation chains for $\mu$/$\nu$ \parencite{Kozen1983,BlackburnRijkeVenema2001}; the probabilistic clauses use pushforward of kernels and monotonicity of measures. The idiom index simply threads distinct $R_{\mathsf{I}}$ through the back/forth conditions.

\paragraph{Operational consequence.} If models in $\mathsf{Set}$ or $\mathsf{Cat}$ compile to a quotient flow $P$ (idiom $\mathsf{QF}$), then $\Box_{\mathsf{Set}}\varphi \Rightarrow \Box_{\mathsf{QF}}\varphi$ provided the compiler is an idiom p-morphism (which is exactly what the \emph{compile-time contracts} enforce; Section~\ref{sec:types}) \parencite{elliott2025contracts,elliott2025graded,elliott2025qfi}.

\section{Drift, fixpoints, and discoverability}\label{sec:drift}
We extend the frame with an \emph{ergodic coverage assumption}: for any finite path $\pi^\star$ there exists a small-ball success floor $q_\pi>0$ under drift, implying eventual visitation with probability one. This is the \emph{drift-validity} engine \parencite{elliott2025drift,MeynTweedie2009,KochenStone1964,Freedman1975}. Then:

\begin{proposition}[Liveness discoverability]
If $\varphi=\mu X.\,\psi(X)$ with $\psi$ monotone and local, and the acceptance set of $\psi$ has drift success floor $q>0$, then for any $w$ with $w\Vdash\varphi$ there exist Murphy budgets $(\alpha,\beta)$ and horizon $L_c\sim \log(1/\beta)/(\alpha I(\theta))$ s.t.\ the event “$\varphi$ witnesses are reached by time $L_c$” occurs with probability $\ge 1-\beta$, where $I(\theta)$ is the occupancy rate function computed on the quotient $P$ \parencite{elliott2025qfi,DemboZeitouni1998,elliott2025pmb}.
\end{proposition}

\noindent\emph{Interpretation.} $\mu$-truth is not merely semantic; it is \emph{schedulable}. The Murphy horizon inherits from the spectral tilt $\Lambda(t)=\log\rho(\mathrm{diag}(e^{t\cdot \1_S})P)$ used by QFI, contracting to the LDP rate $I(\theta)$ that governs discovery latency \parencite{elliott2025qfi,DemboZeitouni1998}.

\section{Invariant transport and FI/CRLB alignment}\label{sec:transport}
When idioms are connected by \emph{idiom projections} $K$ that are sufficient in Blackwell’s sense, FI transports exactly; otherwise it contracts, and CRLB bounds widen \parencite{Blackwell1953,AmariNagaoka2000,Cencov1982,CoverThomas2006,elliott2025idiom}. Modal truths designed to respect these projections remain invariant across idioms: formulas that quantify over sufficient summaries are preserved, while those that demand lost distinctions must be downgraded to $\Box^{\ge q}$ in the receiving idiom. This explains the alignment between FI curvature spikes and Flow-Central bottlenecks \parencite{elliott2025flow}.

\section{QFI-compatibility and Flow-Central routing}\label{sec:qfi}
The shell is \emph{QFI-compatible} if for every $\Box^{\ge q}\varphi$ there is a target set $S$ on the quotient for which $\varphi$ reduces to an occupancy event. Then Murphy horizons can be read off from $I_S(\theta)$, and \emph{Action--Betweenness} spikes mark where forbidding a node inflates optimal tilted cost $J^\star$ (diagnosing fragile routes) \parencite{elliott2025qfi,elliott2025flow}. This yields a \emph{routing logic}: promote $\nu$-safety formulas on high betweenness edges and schedule $\mu$-liveness proofs along central channels first.

\section{Typed effects and compile-time safety}\label{sec:types}
Atomic predicates $a\in\mathsf{AP}$ are \emph{typed claims} guarded by contracts and graded effects: each inference action has a grade vector $(b,K,H,\sigma,\alpha)$ controlling budget, kernel validity, hazard, measurability, and information price. Composition preserves grades; modalities are admissible only if the grade transformer is sub-additive and contract-safe \parencite{elliott2025contracts,elliott2025graded}. This is the static layer that guarantees idiom p-morphism at compile time.

\section{Soundness, completeness (fragment), and coalgebraic view}\label{sec:sc}
\paragraph{Soundness.} The axioms K+fixpoint (with Park induction) are sound for the idiom frames defined above; the probabilistic boxes obey the standard threshold axioms for subprobability kernels \parencite[Ch.\ 8]{BlackburnRijkeVenema2001}.

\paragraph{Completeness (fragment).} Over finite quotient frames with total drift, the Kozen axiomatization is complete for the $\mu$-fragment; idiom indices behave as disjoint modalities, so the usual filtration arguments apply \parencite{Kozen1983,Stirling2001}.

\paragraph{Coalgebra.} The shell can be read as a coalgebraic logic over the functor $F(X)=\mathcal{D}(X)\times \prod_{\mathsf{I}}\mathcal{P}(X)$ (distributions $\times$ adjacencies), with predicate liftings for thresholds and boxes \parencite{Rutten2000,Jacobs2017}. This presentation clarifies why p-morphisms are exactly structure-preserving maps and why truth is functorial under compilation.

\section{Worked example: necessity under coarse-graining}
Consider a finite path model $x_0\to x_1\to x_2$ with parameter $\theta$ controlling the middle edge. The safety claim
\[
\nu X.\,\Big(a_{\textsf{safe}} \land \Box^{\ge 1-\epsilon} X\Big)
\]
holds in the fine idiom if the drift avoids hazard states with probability $\ge 1-\epsilon$. Coarse-graining that removes $x_1$ may break the box unless the projection is sufficient (score is measurable w.r.t.\ the coarse $\sigma$-algebra) \parencite{Blackwell1953,AmariNagaoka2000}. On the quotient $P$, the Murphy horizon for re-validating the claim follows from QFI’s $I_S(\theta)$; Flow Centrality will flag the middle edge as a betweenness bottleneck \parencite{elliott2025qfi,elliott2025flow,DemboZeitouni1998}.

\section{Falsifiers and diagnostics}
\emph{Falsifiers} include: (i) violation of p-morphism conditions (detected by contract/type checks), (ii) FI strictly contracting across all projections of interest (no sufficient statistics), (iii) lumpability error overwhelming the spectral gap (unstable tilts), and (iv) drift violating small-ball floors (no coverage). These are precisely the alarms implemented across the stack \parencite{elliott2025idiom,elliott2025qfi,elliott2025drift,elliott2025flow}.

\section*{Acknowledgments}
This version integrates syntax, semantics, p-morphism preservation, FI/CRLB transport alignment, drift discoverability, QFI-compatibility, and typed contracts in a single file, matching the instrumentation used in KI-\(\Delta\)2.

\printbibliography

\end{document}